<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS: Mobile-Optimized Apex</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; touch-action: none; }
        #input_video { position: absolute; width: 100vw; height: 100vh; object-fit: cover; transform: scaleX(-1); z-index: -1; }
        #biometric_canvas { position: absolute; width: 100vw; height: 100vh; z-index: 5; transform: scaleX(-1); pointer-events: none; }
        #three_canvas { position: absolute; top: 0; left: 0; z-index: 10; pointer-events: none; }
        #status { 
            position: absolute; top: 20px; left: 20px; z-index: 100;
            color: #00f0ff; font-family: 'Courier New', monospace; font-size: 12px;
            text-shadow: 0 0 10px #00f0ff; border-left: 3px solid #00f0ff; padding-left: 10px;
        }
        #resize_ui {
            position: absolute; top: 20px; right: 20px; z-index: 100;
            color: #ff3333; font-family: 'Courier New', monospace; font-size: 14px;
            padding: 8px; border: 1px solid #ff3333; display: none;
            background: rgba(0,0,0,0.5); text-shadow: 0 0 5px #ff3333;
        }
    </style>
</head>
<body>
    <div id="status">INITIATING MOBILE-OPTIMIZED AR...</div>
    <div id="resize_ui">RESIZE ACTIVATED</div>
    <video id="input_video" autoplay playsinline></video>
    <canvas id="biometric_canvas"></canvas>
    <canvas id="three_canvas"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        const status = document.getElementById('status');
        const resizeUI = document.getElementById('resize_ui');
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('biometric_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        
        let rotationMomentum = 0.0015;
        let prevHand2X = null;
        let activeHandLabel = null;
        let pinchStartTime = null;
        let isResizeMode = false;
        let currentScale = 1.0;

        // 1. DYNAMIC MOBILE ENGINE
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ 
            canvas: document.getElementById('three_canvas'),
            antialias: true, alpha: true, logarithmicDepthBuffer: true
        });

        function updateScreen() {
            const w = window.innerWidth;
            const h = window.innerHeight;
            renderer.setSize(w, h);
            camera.aspect = w / h;
            camera.updateProjectionMatrix();

            // --- MOBILE SIZE FIX ---
            // If screen is taller than wide, reduce the Earth's base scale to fit
            window.isMobile = w < h;
            window.baseScale = isMobile ? 0.65 : 1.0; 
        }
        updateScreen();
        window.addEventListener('resize', updateScreen);

        const vFOV = (camera.fov * Math.PI) / 180;
        const visibleHeight = 2 * Math.tan(vFOV / 2) * 10;

        // 2. ULTRA-HD ASSETS
        const earthGroup = new THREE.Group();
        earthGroup.visible = false; 
        scene.add(earthGroup);

        const loader = new THREE.TextureLoader();
        const earthMat = new THREE.MeshPhongMaterial({ 
            map: loader.load('https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg'),
            specularMap: loader.load('https://threejs.org/examples/textures/planets/earth_specular_2048.jpg'),
            bumpMap: loader.load('https://threejs.org/examples/textures/planets/earth_normal_2048.jpg'),
            bumpScale: 0.08, shininess: 50 
        });
        const earth = new THREE.Mesh(new THREE.SphereGeometry(2.3, 128, 128), earthMat);
        earthGroup.add(earth);

        const clouds = new THREE.Mesh(
            new THREE.SphereGeometry(2.36, 128, 128),
            new THREE.MeshPhongMaterial({ map: loader.load('https://threejs.org/examples/textures/planets/earth_clouds_1024.png'), transparent: true, opacity: 0.85 })
        );
        earthGroup.add(clouds);

        scene.add(new THREE.AmbientLight(0xffffff, 0.45));
        const sun = new THREE.DirectionalLight(0xffffff, 2.2);
        sun.position.set(5, 3, 5);
        scene.add(sun);
        camera.position.z = 10;

        // 3. GESTURE LOGIC (Optimized for Screen Ratios)
        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                let h1 = null, h2 = null;
                results.multiHandLandmarks.forEach((landmarks, index) => {
                    const label = results.multiHandedness[index].label;
                    drawLandmarks(canvasCtx, landmarks, {color: '#FFFFFF', lineWidth: 1.5, radius: isMobile ? 2 : 4});
                    if (activeHandLabel === null) activeHandLabel = label;
                    if (label === activeHandLabel) h1 = landmarks;
                    else h2 = landmarks;
                });

                if (h1) {
                    const wrist = h1[0], indexTip = h1[8], mid = h1[9];
                    const distToFist = Math.hypot(indexTip.x - wrist.x, indexTip.y - wrist.y);
                    
                    if (distToFist > 0.18) {
                        earthGroup.visible = true;
                        const curVisWidth = visibleHeight * (window.innerWidth / window.innerHeight);
                        const tx = (mid.x - 0.5) * -curVisWidth;
                        const ty = (mid.y - 0.5) * -visibleHeight;
                        
                        // Vertical Lift: Reduced on mobile so it doesn't leave the screen top
                        const lift = isMobile ? 1.8 : 3.0;
                        earthGroup.position.lerp(new THREE.Vector3(tx, ty + lift, 0), 0.15);
                        
                        // Default scaling to the "Base Scale" calculated on resize
                        if (!isResizeMode) {
                            earthGroup.scale.lerp(new THREE.Vector3(baseScale, baseScale, baseScale), 0.1);
                        }
                    } else { earthGroup.visible = false; }
                }

                if (h2 && earthGroup.visible) {
                    const thumbTip = h2[4], indexTip = h2[8], mid2 = h2[9];
                    const rawDist = Math.hypot(thumbTip.x - indexTip.x, thumbTip.y - indexTip.y);
                    
                    if (rawDist < 0.04) {
                        if (pinchStartTime === null) pinchStartTime = Date.now();
                        if (Date.now() - pinchStartTime > 1000) {
                            isResizeMode = true;
                            resizeUI.style.display = 'block';
                        }
                    } else if (!isResizeMode) pinchStartTime = null;

                    if (isResizeMode) {
                        currentScale = THREE.MathUtils.lerp(currentScale, rawDist * (isMobile ? 12.0 : 10.0), 0.1);
                        earthGroup.scale.setScalar(THREE.MathUtils.clamp(currentScale, 0.2, 4.0));
                    } else {
                        const curX = mid2.x;
                        if (prevHand2X !== null) {
                            const deltaX = curX - prevHand2X;
                            if (Math.abs(deltaX) > 0.015) rotationMomentum += deltaX * 0.45;
                        }
                        prevHand2X = curX;
                    }
                } else {
                    isResizeMode = false;
                    pinchStartTime = null;
                    resizeUI.style.display = 'none';
                    prevHand2X = null;
                }
            } else { earthGroup.visible = false; activeHandLabel = null; }
            canvasCtx.restore();
        }

        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hands.setOptions({ 
            maxNumHands: 2, 
            modelComplexity: isMobile ? 0 : 1, // Simpler model for mobile performance
            minDetectionConfidence: 0.8, 
            minTrackingConfidence: 0.8 
        });
        hands.onResults(onResults);

        new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 1280, height: 720
        }).start();

        function animate() {
            requestAnimationFrame(animate);
            earth.rotation.y += rotationMomentum;
            clouds.rotation.y += rotationMomentum * 1.15;
            rotationMomentum *= 0.985;
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
